import{M as G,a as $,f as pe,I as H,g as ee,p as me,q as _e,D as fe,r as ve,_ as te,U as ge,F as ae,B as ne,S as ye,j as he,w as ie,z as be,A as xe,s as ke,u as we,v as Ce}from"./ant-design-vue--Wr84Izy.js";import{_ as Oe}from"./SvgIcon-D33RiJgU.js";import{h as K,c as oe,C as Te,a as Ie,b as $e}from"./index-BsLPKckO.js";import{_ as E}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{Q as Se,T as De,V as Ue}from"./@ant-design-B-ejxF28.js";import{r as d,o as P,a0 as I,a5 as W,c as e,a1 as t,a2 as f,G as T,u as s,H as R,$ as D,ab as Me,e as z,a7 as Ke,a as B,w as X,k as Ne,D as ze,Z as le}from"./@vue-B5btswkz.js";import{_ as qe}from"./upload-4vm4seBQ.js";import"./dayjs-bdfbxlhH.js";import"./@babel-Dd5QU_Ri.js";import"./lodash-es-CSO40SSR.js";import"./resize-observer-polyfill-B1PUzC5B.js";import"./vue-types-B67A5qzE.js";import"./@ctrl-3cdSgQbg.js";import"./dom-align-OCOKWGcj.js";import"./async-validator-P8scd9xB.js";import"./scroll-into-view-if-needed-BYx7v0DY.js";import"./compute-scroll-into-view-1gs_hJI2.js";import"./axios-upsvKRUO.js";import"./vue-router-D8gsG8iB.js";import"./pinia-DuIsOk5z.js";import"./vxe-pc-ui-B3rMWPmo.js";import"./xe-utils-BVyeMf_3.js";import"./@vxe-ui-ivSiCnOc.js";import"./dom-zindex-DlWB42XF.js";import"./vxe-table-CY8UZVkh.js";function Fe(){return K.request({method:"get",url:"/api/ask-data/tree-nodes",params:{}})}function Le(i){return K.request({method:"post",url:"/api/ask-data/tree-nodes",data:i})}function Re(i,u){return K.request({method:"put",url:`/api/ask-data/tree-nodes/${i}`,data:u})}function je(i){return K.request({method:"delete",url:`/api/ask-data/tree-nodes/${i}`})}function Ae(i){return K.request({method:"get",url:"/api/ask-data/datasets/",params:i})}function Be(i){return K.request({method:"delete",url:`/api/ask-data/datasets/${i}`,data:{}})}function Ee(i,u){return K.request({method:"put",url:`/api/ask-data/datasets/${i}`,data:u})}function Ve(i){return K.request({headers:{"Content-Type":"multipart/form-data"},method:"post",url:"/api/ask-data/datasets/upload",data:i})}function Ge(i,u){return K.request({method:"get",url:`/api/ask-data/columns/dataset/${i}`,params:u})}function He(i,u){return K.request({method:"put",url:`/api/ask-data/columns/${i}`,data:u})}const Pe={class:"tree-container"},Qe={class:"form-main beautify-scrollbar"},We={style:{"margin-top":"20px"}},Ye={style:{"margin-top":"20px"}},Ze=["title","onClick"],Je={__name:"dataManageTree",emits:["setSelectedTreeKey"],setup(i,{expose:u,emit:y}){const p=d(0),r=d([]),l=d(!1),h=d(""),k=d(""),b=d(!1),w=d({}),C=d([]);d(!1);const S=y,q=d(oe().isAdministrator());P(async()=>{await c();const a=n(r.value);C.value=[a],S("setSelectedTreeKey",C.value[0])});const m=(a,o)=>{C.value[0]!==a[0]&&(C.value=a,S("setSelectedTreeKey",C.value[0]))},n=a=>{let o=a[0];for(;o.children.length>0;)o=o.children[0];return o.id},c=async()=>{const a=await Fe();debugger;r.value=[a.data]},_=a=>{debugger;if(w.value=a,!!a.menuKey)switch(a.menuKey){case"newNode":U();break;case"rename":M(a);break;case"delete":N();break}},U=a=>{b.value=!0,l.value=!0,p.value=0,h.value=""},N=a=>{G.confirm({title:"确认删除该节点?",content:"删除后，节点不可恢复",okText:"确定",cancelText:"取消",onOk(){return je(w.value.id).then(()=>{$.success("删除成功"),c()})},onCancel(){}})},M=a=>{h.value=a.name,p.value=a.sortOrder,k.value=a.description,l.value=!0},v=async()=>{if(!h.value){$.warning("请输入节点名称");return}if(b.value){const a={pid:w.value.id,name:h.value,sortOrder:p.value||0,description:k.value};await Le(a).catch(V=>{$.warning("节点名称存在重复，请重新输入")})&&(h.value="",c(),$.success("新增成功"),w.value={},l.value=!1,p.value=0)}else{const a={name:h.value,sortOrder:p.value,description:k.value};await Re(w.value.id,a).catch(V=>{$.warning("节点名称存在重复，请重新输入")})&&(c(),$.success("修改成功"),w.value={},l.value=!1,p.value=0)}b.value=!1};return u({refreshTreeData:c}),(a,o)=>{const V=pe,Y=H,x=ee,g=G,j=Oe,A=me,Z=_e,F=fe,J=ve;return I(),W("div",Pe,[e(g,{visible:s(l),"onUpdate:visible":o[3]||(o[3]=O=>R(l)?l.value=O:null),title:s(b)?"新增节点":"修改节点","cancel-text":"取消","ok-text":"确认",onOk:v,onCancel:a.handleCancel,style:{padding:"0px",width:"40%",top:"6vh"},destroyOnClose:!0},{default:t(()=>[f("div",Qe,[f("div",null,[o[4]||(o[4]=f("span",{class:"item-label"},[f("span",{style:{color:"red"}},"*"),T(" 顺序:")],-1)),f("div",null,[e(V,{id:"inputNumber",value:s(p),"onUpdate:value":o[0]||(o[0]=O=>R(p)?p.value=O:null),min:0},null,8,["value"])])]),f("div",We,[o[5]||(o[5]=f("span",{class:"item-label"},[f("span",{style:{color:"red"}},"*"),T("节点名称：")],-1)),e(Y,{value:s(h),"onUpdate:value":o[1]||(o[1]=O=>R(h)?h.value=O:null),placeholder:"请输入节点名称"},null,8,["value"])]),f("div",Ye,[o[6]||(o[6]=f("span",{class:"item-label"},"节点描述:",-1)),e(x,{value:s(k),"onUpdate:value":o[2]||(o[2]=O=>R(k)?k.value=O:null),placeholder:"请输入节点描述",rows:2},null,8,["value"])])])]),_:1},8,["visible","title","onCancel"]),s(r).length?(I(),D(J,{key:0,"tree-data":s(r),blockNode:!0,virtual:!1,fieldNames:{children:"children",title:"name",key:"id"},defaultExpandAll:!0,selectedKeys:s(C)},{title:t(O=>[e(F,{trigger:["contextmenu"]},Me({default:t(()=>[f("span",{class:"node-content",title:O.description||O.name,onClick:Q=>m([O.data.id])},[a.children&&a.children.length!==0?(I(),D(j,{key:0,name:"wjj",style:{width:"15px",height:"15px",display:"inline-block",position:"relative",bottom:"2px"}})):z("",!0),T(" "+Ke(O.name),1)],8,Ze)]),_:2},[s(q)?{name:"overlay",fn:t(()=>[e(Z,{onClick:({key:Q})=>_({...O.data,menuKey:Q})},{default:t(()=>[e(A,{key:"newNode"},{icon:t(()=>[e(s(Se))]),default:t(()=>[o[7]||(o[7]=T(" 新建节点 "))]),_:1}),e(A,{key:"rename"},{icon:t(()=>[e(s(De))]),default:t(()=>[o[8]||(o[8]=T(" 修改 "))]),_:1}),e(A,{key:"delete",danger:""},{icon:t(()=>[e(s(Ue))]),default:t(()=>[o[9]||(o[9]=T(" 删除 "))]),_:1})]),_:2},1032,["onClick"])]),key:"0"}:void 0]),1024)]),_:1},8,["tree-data","selectedKeys"])):z("",!0)])}}},Xe=E(Je,[["__scopeId","data-v-93e80822"]]),et={__name:"UpLoadFileModal",props:{modalOpen:{type:Boolean,default:!1},selectedTreeKey:{type:String,default:""}},emits:["update:modalOpen","upload-success"],setup(i,{emit:u}){const y=d(null);Ie().get(Te.TOKEN_NAME);const r=B({name:"",description:"",file:null}),l=i,h=u,k=d([]),b=d(!1),w=m=>{const n=["xlsx","xls","csv","zip"],c=m.name.split(".").pop().toLowerCase();return n.includes(c)||$.error("仅支持上传文档（xlsx/xls/csv/zip）"),!1},C=()=>{y.value.validateFields().then(async()=>{var n,c;b.value=!0;const m=new FormData;Object.keys(r).forEach(_=>{_==="file"?m.append(_,r[_][0].originFileObj):m.append(_,r[_])}),m.append("tree_node_id",l.selectedTreeKey);try{await Ve(m),$.success("上传成功"),k.value=[],S()}catch(_){$.error("上传失败: "+(((c=(n=_.response)==null?void 0:n.data)==null?void 0:c.message)||_.message))}finally{b.value=!1}}).catch(m=>{$.warning("请将必填项填写完整")})},S=()=>{b.value=!1,h("update:modalOpen",!1)},q=()=>{h("update:modalOpen",!1)};return(m,n)=>{const c=H,_=te,U=ee,N=ge,M=ae,v=G;return I(),D(v,{style:{width:"50%"},visible:i.modalOpen,title:"上传数据","cancel-text":"取消","confirm-loading":b.value,destroyOnClose:!0,"ok-text":"保存",onOk:C,onCancel:q},{default:t(()=>[e(M,{model:r,labelCol:{span:3,offset:1},ref_key:"form",ref:y},{default:t(()=>[e(_,{label:"数据名称",name:"name",rules:[{required:!0,message:"请输入名称"}]},{default:t(()=>[e(c,{value:r.name,"onUpdate:value":n[0]||(n[0]=a=>r.name=a)},null,8,["value"])]),_:1}),e(_,{label:"数据描述",name:"description"},{default:t(()=>[e(U,{value:r.description,"onUpdate:value":n[1]||(n[1]=a=>r.description=a)},null,8,["value"])]),_:1}),e(_,{label:"数据文件",name:"file",rules:[{required:!0,message:"请上传文件"}]},{default:t(()=>[e(N,{fileList:r.file,"onUpdate:fileList":n[2]||(n[2]=a=>r.file=a),name:"files",multiple:!1,"max-count":1,accept:".xlsx,.xls,.csv,.zip","before-upload":w,onChange:m.handleChange,onDrop:m.handleDrop,showUploadList:{showRemoveIcon:!b.value}},{default:t(()=>n[3]||(n[3]=[f("div",{class:"ant-upload-drag-icon"},[f("img",{src:qe}),f("p",{style:{color:"#4687fe","font-weight":"600"}},"上传本地文件"),f("p",{style:{color:"#4687fe"}},".xlsx、.xls、.csv、.zip")],-1)])),_:1},8,["fileList","onChange","onDrop","showUploadList"])]),_:1})]),_:1},8,["model"])]),_:1},8,["visible","confirm-loading"])}}},tt=E(et,[["__scopeId","data-v-21d1327b"]]),at={__name:"basicInformation",props:{datasetId:{type:String,default:""},dataRecord:{type:Object,default:{}}},setup(i){const u=B({name:"",description:""}),y=i;P(()=>{debugger;const{name:r,description:l}=y.dataRecord;debugger;u.name=r,u.description=l});const p=async r=>{try{await Ee(y.datasetId,r),$.success("保存成功")}catch{}};return(r,l)=>{const h=ne,k=te,b=H,w=ee,C=ae;return I(),D(C,{model:s(u),labelCol:{span:2,offset:0},ref:"form",onFinish:p},{default:t(()=>[e(k,{style:{"text-align":"right"}},{default:t(()=>[e(h,{type:"primary","html-type":"submit"},{default:t(()=>l[2]||(l[2]=[T("保存")])),_:1})]),_:1}),e(k,{label:"数据名称",name:"name",rules:[{required:!0,message:"请输入名称"}]},{default:t(()=>[e(b,{value:s(u).name,"onUpdate:value":l[0]||(l[0]=S=>s(u).name=S)},null,8,["value"])]),_:1}),e(k,{label:"数据描述",name:"description"},{default:t(()=>[e(w,{value:s(u).description,"onUpdate:value":l[1]||(l[1]=S=>s(u).description=S)},null,8,["value"])]),_:1})]),_:1},8,["model"])}}},nt={class:"field-manager"},ot={class:"search-section"},st={style:{"text-align":"right"}},lt={class:"table-section"},it={__name:"fieldManagement",props:{datasetId:{type:String,default:""}},setup(i){const u=d({}),y=B({name:""}),p=d([]),r=i,l=B({current:1,pageSize:10,total:50,showSizeChanger:!0,pageSizeOptions:["10","20","50","100"],showTotal:m=>`共 ${m} 条`}),h=[{title:"字段名称",dataIndex:"name",key:"name",width:120,align:"center"},{title:"字段类型",dataIndex:"type",key:"type",width:120,align:"center"},{title:"字段别名",dataIndex:"alias",key:"alias",width:150,align:"center",slots:{customRender:"alias"}},{title:"字段描述",dataIndex:"description",key:"description",width:200,align:"center",slots:{customRender:"description"}}];P(()=>{w()});const k=()=>{const m=Object.keys(u.value).map(n=>{const c=u.value[n];debugger;return He(c.id,c)});Promise.all(m).then(()=>{$.success("保存成功")})},b=m=>{Object.assign(l,m),u.value={},w()},w=async()=>{try{const m={...y,page:l.current,per_page:l.pageSize},n=await Ge(r.datasetId,m);l.total=n.pagination.total,p.value=n.data}catch{$.error("数据加载失败")}finally{}},C=(m,n,c)=>{p.value[m][n]=c;const _=p.value[m].id;u.value[_]=p.value[m],console.log(`字段 ${n} 已更新为: ${c}`)},S=()=>{w()},q=()=>{Object.assign(y,{name:""}),w()};return(m,n)=>{const c=H,_=ne,U=ye,N=he,M=ie;return I(),W("div",nt,[f("div",ot,[n[3]||(n[3]=f("span",{class:"search-label"},"字段名称：",-1)),e(c,{value:y.name,"onUpdate:value":n[0]||(n[0]=v=>y.name=v),placeholder:"请输入关键字进行搜索",style:{width:"200px","margin-right":"10px"}},null,8,["value"]),e(_,{type:"primary",onClick:S},{default:t(()=>n[1]||(n[1]=[T("搜索")])),_:1}),e(_,{onClick:q,style:{"margin-left":"8px"}},{default:t(()=>n[2]||(n[2]=[T("重置")])),_:1})]),f("div",st,[e(_,{type:"primary",onClick:k},{default:t(()=>n[4]||(n[4]=[T("保存")])),_:1})]),f("div",lt,[e(M,{columns:h,"data-source":s(p),pagination:l,bordered:"",size:"middle",onChange:b,scroll:{x:1200,y:"calc(100vh - 440px)"}},{alias:t(({record:v,index:a})=>[e(c,{value:v.alias,"onUpdate:value":o=>v.alias=o,onChange:o=>C(a,"alias",v.alias),placeholder:"请输入字段别名"},null,8,["value","onUpdate:value","onChange"])]),dimension:t(({record:v,index:a})=>[e(N,{value:v.dimension,"onUpdate:value":o=>v.dimension=o,onChange:o=>C(a,"dimension",v.dimension),style:{width:"100%"},placeholder:"请选择维度"},{default:t(()=>[e(U,{value:"维度"},{default:t(()=>n[5]||(n[5]=[T("维度")])),_:1})]),_:2},1032,["value","onUpdate:value","onChange"])]),description:t(({record:v,index:a})=>[e(c,{value:v.description,"onUpdate:value":o=>v.description=o,onChange:o=>C(a,"description",v.description),placeholder:"请输入字段描述"},null,8,["value","onUpdate:value","onChange"])]),fieldMapping:t(({record:v})=>[e(N,{value:v.fieldMapping,"onUpdate:value":a=>v.fieldMapping=a,style:{width:"100%"},placeholder:"请选择映射",disabled:""},{default:t(()=>[e(U,{value:"图斑细化类型代码表"},{default:t(()=>n[6]||(n[6]=[T("图斑细化类型代码表")])),_:1})]),_:2},1032,["value","onUpdate:value"])]),_:1},8,["data-source","pagination"])])])}}},dt=E(it,[["__scopeId","data-v-705fd70d"]]),rt={__name:"DetailModal",props:{modalOpen:{type:Boolean,default:!1},title:{type:String,default:""},datasetId:{type:String,default:""},dataRecord:{type:Object,default:{}}},emits:["update:modalOpen"],setup(i,{emit:u}){d(oe().isAdministrator());const y=d("1");d(!1),P(async()=>{});const p=u,r=()=>{p("update:modalOpen",!1)},l=()=>{p("update:modalOpen",!1)};return(h,k)=>{const b=be,w=xe,C=G;return I(),D(C,{style:{width:"100vw",top:0,paddingBottom:0,maxWidth:"auto",margin:"0px"},bodyStyle:{height:"calc(100vh - 55px)",overflowY:"auto",padding:"20px"},visible:i.modalOpen,title:i.title+"-编辑","cancel-text":"取消","ok-text":"确认",onOk:r,onCancel:l,footer:null,destroyOnClose:!0},{default:t(()=>[e(w,{activeKey:s(y),"onUpdate:activeKey":k[0]||(k[0]=S=>R(y)?y.value=S:null)},{default:t(()=>[e(b,{key:"1",tab:"基本信息"},{default:t(()=>[e(at,{datasetId:i.datasetId,dataRecord:i.dataRecord},null,8,["datasetId","dataRecord"])]),_:1}),e(b,{key:"2",tab:"字段管理"},{default:t(()=>[e(dt,{datasetId:i.datasetId},null,8,["datasetId"])]),_:1})]),_:1},8,["activeKey"])]),_:1},8,["visible","title"])}}},ut=E(rt,[["__scopeId","data-v-66b5d570"]]),ct={class:"dataManage-table-container"},pt={class:"main-content"},mt={class:"search-section"},_t={class:"table-section"},ft={__name:"dataManageTable",props:{selectedTreeKey:{type:String,required:!0}},emits:["refreshTreeData"],setup(i,{emit:u}){const y=$e(),p=d(oe().isAdministrator());d([]),d(!1);const r=d(!1),l=d(!1),h=d("");d("开始解析");const k=d(""),b=u,w=d({}),C=i,S=()=>{r.value=!0};X(()=>C.selectedTreeKey,x=>{Object.assign(c,{name:""}),M.value=!1,_.current=1,a()}),X(()=>r.value,x=>{x||(a(),b("refreshTreeData"))}),X(()=>l.value,x=>{x||(a(),b("refreshTreeData"))});const q=[{title:"序号",dataIndex:"name",ellipsis:!0},{title:"数据名称",dataIndex:"name",width:120,ellipsis:!0},{title:"数据描述",dataIndex:"description",width:180,align:"center"},{title:"数据类型",dataIndex:"file_path",width:100,align:"center",customRender:({text:x})=>x.split(".").pop()},{title:"操作",dataIndex:"operation",width:150,align:"center",fixed:"right"}],m=x=>{Object.assign(_,x),a()},n=d([]),c=B({name:""}),_=B({current:1,pageSize:10,total:50,showSizeChanger:!0,pageSizeOptions:["10","20","50","100"],showTotal:x=>`共 ${x} 条`}),U=d(!1),N=d(!1),M=d(!1);P(()=>{a(!0)}),Ne(()=>{});const v=x=>{l.value=!0,h.value=x.name,k.value=x.id,w.value={...x}},a=async x=>{try{x||(U.value=!0);const g={...c,page:_.current,per_page:_.pageSize,tree_node_id:C.selectedTreeKey},j=await Ae(g);_.total=j.pagination.total,n.value=j.data}catch{$.error("数据加载失败")}finally{U.value=!1}},o=x=>{G.confirm({title:"确认删除该数据?",content:"删除后，数据不可恢复",okText:"确定",cancelText:"取消",onOk(){return Be([x.id]).then(g=>{$.success("删除成功"),a(),b("refreshTreeData")})},onCancel(){}})},V=()=>{M.value=!0,a()},Y=()=>{Object.assign(c,{name:""}),M.value=!1,a()};return(x,g)=>{const j=H,A=te,Z=le("SearchOutlined"),F=ne,J=le("UndoOutlined"),O=ke,Q=ae,de=we,re=Ce,ue=ie;return I(),W("div",ct,[e(tt,{modalOpen:s(r),"onUpdate:modalOpen":g[0]||(g[0]=L=>R(r)?r.value=L:null),selectedTreeKey:i.selectedTreeKey},null,8,["modalOpen","selectedTreeKey"]),s(l)?(I(),D(ut,{key:0,modalOpen:s(l),"onUpdate:modalOpen":g[1]||(g[1]=L=>R(l)?l.value=L:null),title:s(h),datasetId:s(k),dataRecord:s(w)},null,8,["modalOpen","title","datasetId","dataRecord"])):z("",!0),f("div",pt,[f("div",mt,[e(Q,{model:s(c),layout:"inline",class:"advanced-search-form",onSubmit:ze(V,["prevent"])},{default:t(()=>[e(A,{label:"数据名称",class:"form-item-custom"},{default:t(()=>[e(j,{value:s(c).name,"onUpdate:value":g[2]||(g[2]=L=>s(c).name=L),placeholder:"请输入关键字进行搜索",style:{width:"200px"},"allow-clear":""},null,8,["value"])]),_:1}),e(A,{class:"form-item-custom"},{default:t(()=>[e(O,{size:16},{default:t(()=>[e(F,{"html-type":"submit",loading:s(N),type:"primary"},{icon:t(()=>[e(Z)]),default:t(()=>[g[3]||(g[3]=T(" 搜索 "))]),_:1},8,["loading"]),e(F,{onClick:Y,class:"main-btn"},{icon:t(()=>[e(J)]),default:t(()=>[g[4]||(g[4]=T(" 重置 "))]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),f("div",_t,[e(O,{size:16,style:{"margin-bottom":"20px"}},{default:t(()=>[s(p)?(I(),D(F,{key:0,type:"primary",onClick:S},{default:t(()=>g[5]||(g[5]=[T(" 上传数据 ")])),_:1})):z("",!0)]),_:1}),e(ue,{columns:q,loading:s(U),"data-source":s(n),pagination:s(_),scroll:{x:500,y:s(y).gjMode?"calc(100vh - 82px - 320px)":"calc(100vh - 320px)"},bordered:"",size:"middle","row-key":"id",sticky:"",onChange:m},{bodyCell:t(({column:L,record:se})=>[L.dataIndex==="operation"?(I(),D(O,{key:0,size:4},{default:t(()=>[s(p)?(I(),D(F,{key:0,type:"link",size:"small",onClick:ce=>v(se)},{default:t(()=>g[6]||(g[6]=[T(" 编辑 ")])),_:2},1032,["onClick"])):z("",!0),s(p)?(I(),D(de,{key:1,type:"vertical"})):z("",!0),s(p)?(I(),D(F,{key:2,type:"link",size:"small",style:{color:"#ea3333"},onClick:ce=>o(se)},{default:t(()=>g[7]||(g[7]=[T(" 删除 ")])),_:2},1032,["onClick"])):z("",!0)]),_:2},1024)):z("",!0)]),emptyText:t(()=>[e(re,{description:s(M)?"暂无相关数据":"暂无数据"},null,8,["description"])]),_:1},8,["loading","data-source","pagination","scroll"])])])])}}},vt=E(ft,[["__scopeId","data-v-cd8bda3d"]]),gt={class:"dataManage"},yt={class:"tree"},ht={id:"dataManage-table"},bt={__name:"index",setup(i){const u=d(null),y=d(""),p=l=>{y.value=l},r=()=>{u.value.refreshTreeData()};return(l,h)=>(I(),W("div",gt,[f("div",yt,[e(Xe,{onSetSelectedTreeKey:p,ref_key:"tree",ref:u},null,512)]),f("div",ht,[e(vt,{selectedTreeKey:s(y),onRefreshTreeData:r},null,8,["selectedTreeKey"])])]))}},Ht=E(bt,[["__scopeId","data-v-6639f9bf"]]);export{Ht as default};
